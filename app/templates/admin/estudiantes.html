{% extends "admin/base_admin.html" %}

{% block title %}Estudiantes - EduControl{% endblock %}

{% block page_title %}Gestión de Estudiantes{% endblock %}

{% block breadcrumb %}
<i class="fas fa-chevron-right"></i>
<span>Usuarios</span>
<i class="fas fa-chevron-right"></i>
<span>Estudiantes</span>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Estadísticas Rápidas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <i class="fas fa-users fa-2x text-primary mb-3"></i>
                        <h4 class="card-title text-primary" id="totalEstudiantes">0</h4>
                        <p class="card-text text-muted">Total Estudiantes</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <i class="fas fa-user-check fa-2x text-success mb-3"></i>
                        <h4 class="card-title text-success" id="estudiantesActivos">0</h4>
                        <p class="card-text text-muted">Activos</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <i class="fas fa-user-clock fa-2x text-warning mb-3"></i>
                        <h4 class="card-title text-warning" id="estudiantesInactivos">0</h4>
                        <p class="card-text text-muted">Inactivos</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-info">
                    <div class="card-body">
                        <i class="fas fa-graduation-cap fa-2x text-info mb-3"></i>
                        <h4 class="card-title text-info" id="estudiantesGraduados">0</h4>
                        <p class="card-text text-muted">Graduados</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros y Búsqueda -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-filter me-2"></i>
                    Filtros de Búsqueda
                </h5>
            </div>
            <div class="card-body">
                <form class="row g-4" id="filtrosForm">
                    <div class="col-md-3">
                        <label for="busqueda" class="form-label">Buscar</label>
                        <div class="input-group position-relative">
                            <input type="text" class="form-control" id="busqueda" placeholder="Nombre o documento...">
                            <button class="btn btn-outline-secondary" type="button" onclick="aplicarFiltros()">
                                <i class="fas fa-search"></i>
                            </button>
                            <!-- Indicador de búsqueda -->
                            <div class="search-indicator d-none" id="searchIndicator">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                        <!-- Mensaje de resultados -->
                        <small class="text-muted d-none" id="searchResults"></small>
                    </div>
                    <div class="col-md-2">
                        <label for="grado" class="form-label">Grado</label>
                        <select class="form-select" id="grado" onchange="cargarSecciones()">
                            <option value="">Todos los grados</option>
                            <option value="1">1°</option>
                            <option value="2">2°</option>
                            <option value="3">3°</option>
                            <option value="4">4°</option>
                            <option value="5">5°</option>
                            <option value="6">6°</option>
                            <option value="7">7°</option>
                            <option value="8">8°</option>
                            <option value="9">9°</option>
                            <option value="10">10°</option>
                            <option value="11">11°</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="seccion" class="form-label">Sección</label>
                        <select class="form-select" id="seccion">
                            <option value="">Todas las secciones</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="estado" class="form-label">Estado</label>
                        <select class="form-select" id="estado">
                            <option value="">Todos los estados</option>
                            <option value="activo">Activo</option>
                            <option value="inactivo">Inactivo</option>
                            <option value="graduado">Graduado</option>
                            <option value="retirado">Retirado</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label d-block">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary flex-fill" onclick="aplicarFiltros()">
                                <i class="fas fa-search me-2"></i>
                                Buscar
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="limpiarFiltros()">
                                <i class="fas fa-eraser me-2"></i>
                                Limpiar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Lista de Estudiantes -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-graduate me-2"></i>
                        Lista de Estudiantes
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="exportarEstudiantes()">
                            <i class="fas fa-file-excel me-2"></i>
                            Exportar
                        </button>
                        <button class="btn btn-info" onclick="importarEstudiantes()">
                            <i class="fas fa-file-import me-2"></i>
                            Importar
                        </button>
                        <a href="{{ url_for('admin.estudiantes_nuevo') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>
                            Nuevo Estudiante
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Loading indicator -->
                <div id="loadingIndicator" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando estudiantes...</p>
                </div>

                <!-- Tabla de estudiantes -->
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th>Estudiante</th>
                                <th>Documento</th>
                                <th>Grado/Sección</th>
                                <th>Estado</th>
                                <th>Fecha de Ingreso</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="estudiantes-table">
                            <!-- Los datos se cargarán dinámicamente -->
                        </tbody>
                    </table>
                </div>

                <!-- Paginación -->
                <nav aria-label="Paginación de estudiantes" class="mt-4">
                    <ul class="pagination justify-content-center" id="paginacion">
                        <!-- Se genera dinámicamente -->
                    </ul>
                </nav>

                <!-- Mensaje cuando no hay datos -->
                <div id="noDataMessage" class="text-center py-5" style="display: none;">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No se encontraron estudiantes</h5>
                    <p class="text-muted" id="noDataText">Intenta ajustar los filtros de búsqueda o agrega nuevos estudiantes</p>
                    <a href="{{ url_for('admin.estudiantes_nuevo') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>
                        Agregar Primer Estudiante
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para acciones masivas -->
<div class="modal fade" id="accionesMasivasModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tasks me-2"></i>
                    Acciones Masivas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Qué acción deseas realizar con los <span id="estudiantesSeleccionados">0</span> estudiantes seleccionados?</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="cambiarEstadoMasivo('activo')">
                        <i class="fas fa-user-check me-2"></i>
                        Activar Estudiantes
                    </button>
                    <button class="btn btn-warning" onclick="cambiarEstadoMasivo('inactivo')">
                        <i class="fas fa-user-times me-2"></i>
                        Desactivar Estudiantes
                    </button>
                    <button class="btn btn-info" onclick="exportarSeleccionados()">
                        <i class="fas fa-file-export me-2"></i>
                        Exportar Seleccionados
                    </button>
                    <button class="btn btn-danger" onclick="eliminarSeleccionados()">
                        <i class="fas fa-trash me-2"></i>
                        Eliminar Seleccionados
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_js %}
<script>
    // Variables globales
    let estudiantesData = [];
    let estudiantesFiltrados = [];
    let paginaActual = 1;
    let estudiantesPorPagina = 10;
    let estudiantesSeleccionados = [];
    let searchTimeout = null; // Para el debounce
    let isSearching = false; // Para evitar búsquedas múltiples

    // Inicializar cuando cargue la página
    document.addEventListener('DOMContentLoaded', function() {
        cargarEstudiantes();
        inicializarEventos();
    });

    // Inicializar todos los eventos
    function inicializarEventos() {
        // Eventos de búsqueda
        const busquedaInput = document.getElementById('busqueda');
        const btnBuscar = document.querySelector('.btn-outline-secondary');
        
        // Verificar que los elementos existen
        if (!busquedaInput) {
            console.error('No se encontró el campo de búsqueda');
            return;
        }

        // Búsqueda en tiempo real con debounce
        busquedaInput.addEventListener('input', function(e) {
            console.log('Input detectado:', e.target.value); // Debug
            
            clearTimeout(searchTimeout);
            const valor = this.value.trim();
            
            // Mostrar indicador de búsqueda
            if (valor.length > 0) {
                mostrarIndicadorBusqueda(true);
            }
            
            // Aplicar filtros después de 300ms sin escribir
            searchTimeout = setTimeout(() => {
                console.log('Aplicando filtros por input:', valor); // Debug
                aplicarFiltros();
                mostrarIndicadorBusqueda(false);
            }, 300);
        });

        // Búsqueda al presionar Enter
        busquedaInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                console.log('Enter presionado, aplicando filtros'); // Debug
                clearTimeout(searchTimeout);
                aplicarFiltros();
                mostrarIndicadorBusqueda(false);
            }
        });

        // Búsqueda al hacer clic en el botón
        if (btnBuscar) {
            btnBuscar.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Botón de búsqueda clickeado'); // Debug
                clearTimeout(searchTimeout);
                aplicarFiltros();
                mostrarIndicadorBusqueda(false);
            });
        }

        // Eventos de filtros
        document.getElementById('grado').addEventListener('change', function() {
            console.log('Grado cambiado:', this.value); // Debug
            cargarSecciones();
            aplicarFiltros();
        });

        document.getElementById('seccion').addEventListener('change', function() {
            console.log('Sección cambiada:', this.value); // Debug
            aplicarFiltros();
        });

        document.getElementById('estado').addEventListener('change', function() {
            console.log('Estado cambiado:', this.value); // Debug
            aplicarFiltros();
        });
    }

    // Mostrar/ocultar indicador de búsqueda
    function mostrarIndicadorBusqueda(mostrar) {
        const indicator = document.getElementById('searchIndicator');
        if (mostrar) {
            indicator.classList.remove('d-none');
        } else {
            indicator.classList.add('d-none');
        }
    }

    // Función para cargar estudiantes
    async function cargarEstudiantes() {
        mostrarLoading(true);
        
        try {
            const response = await fetch('/admin/api/estudiantes');
            if (response.ok) {
                estudiantesData = await response.json();
                estudiantesFiltrados = [...estudiantesData];
                renderizarTabla();
                actualizarEstadisticas();
            } else {
                throw new Error('Error al cargar estudiantes');
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarNoData();
            showNotification('Error al cargar los estudiantes', 'error');
        } finally {
            mostrarLoading(false);
        }
    }

    // Mostrar/ocultar loading
    function mostrarLoading(mostrar) {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const tableResponsive = document.querySelector('.table-responsive');
        
        if (mostrar) {
            loadingIndicator.style.display = 'block';
            tableResponsive.style.opacity = '0.5';
        } else {
            loadingIndicator.style.display = 'none';
            tableResponsive.style.opacity = '1';
        }
    }

    // Mostrar mensaje cuando no hay datos
    function mostrarNoData() {
        const noDataMessage = document.getElementById('noDataMessage');
        const tableResponsive = document.querySelector('.table-responsive');
        const noDataText = document.getElementById('noDataText');
        const busqueda = document.getElementById('busqueda').value.trim();
        
        let mensaje = 'Intenta ajustar los filtros de búsqueda o agrega nuevos estudiantes';
        
        if (busqueda) {
            mensaje = `No se encontraron estudiantes que coincidan con "${busqueda}". Verifica la ortografía o intenta con otros términos.`;
        } else if (estudiantesData.length === 0) {
            mensaje = 'Aún no hay estudiantes registrados en el sistema. ¡Agrega el primer estudiante!';
        }
        
        noDataText.textContent = mensaje;
        
        if (estudiantesFiltrados.length === 0) {
            noDataMessage.style.display = 'block';
            tableResponsive.style.display = 'none';
        } else {
            noDataMessage.style.display = 'none';
            tableResponsive.style.display = 'block';
        }
    }

    // Renderizar tabla de estudiantes
    function renderizarTabla() {
        const tbody = document.getElementById('estudiantes-table');
        const inicio = (paginaActual - 1) * estudiantesPorPagina;
        const fin = inicio + estudiantesPorPagina;
        const estudiantesPagina = estudiantesFiltrados.slice(inicio, fin);

        if (estudiantesPagina.length === 0) {
            if (estudiantesFiltrados.length === 0) {
                mostrarNoData();
                return;
            } else {
                // Si hay estudiantes filtrados pero no en esta página, ir a la primera página
                paginaActual = 1;
                renderizarTabla();
                return;
            }
        }

        tbody.innerHTML = estudiantesPagina.map(estudiante => `
            <tr>
                <td>
                    <input type="checkbox" class="form-check-input estudiante-checkbox" 
                           value="${estudiante.id}" onchange="actualizarSeleccion()">
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="avatar-inicial me-3">
                            ${estudiante.nombre.charAt(0)}${estudiante.apellido.charAt(0)}
                        </div>
                        <div>
                            <div class="fw-bold">${estudiante.nombre} ${estudiante.apellido}</div>
                            <div class="text-muted small">${estudiante.email || 'Sin email'}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="fw-bold">${estudiante.documento}</span>
                    <div class="text-muted small">${estudiante.tipo_documento || 'CC'}</div>
                </td>
                <td>
                    <span class="badge bg-info">${estudiante.grado}° ${estudiante.seccion || ''}</span>
                </td>
                <td>
                    <span class="badge bg-${getEstadoColor(estudiante.estado)}">
                        ${estudiante.estado.charAt(0).toUpperCase() + estudiante.estado.slice(1)}
                    </span>
                </td>
                <td>
                    <span class="fw-bold">${formatearFecha(estudiante.fecha_ingreso)}</span>
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="verEstudiante(${estudiante.id})" title="Ver">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editarEstudiante(${estudiante.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="eliminarEstudiante(${estudiante.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');

        generarPaginacion();
        document.getElementById('noDataMessage').style.display = 'none';
        document.querySelector('.table-responsive').style.display = 'block';
        
        // Mostrar resultados de búsqueda
        mostrarResultadosBusqueda();
    }

    // Mostrar resultados de búsqueda
    function mostrarResultadosBusqueda() {
        const searchResults = document.getElementById('searchResults');
        const busqueda = document.getElementById('busqueda').value.trim();
        
        if (busqueda) {
            const total = estudiantesData.length;
            const encontrados = estudiantesFiltrados.length;
            
            if (encontrados === 0) {
                searchResults.textContent = `No se encontraron resultados para "${busqueda}"`;
                searchResults.className = 'text-danger small';
            } else {
                searchResults.textContent = `${encontrados} de ${total} estudiantes encontrados`;
                searchResults.className = 'text-success small';
            }
            searchResults.classList.remove('d-none');
        } else {
            searchResults.classList.add('d-none');
        }
    }

    // Obtener color del estado
    function getEstadoColor(estado) {
        const colores = {
            'activo': 'success',
            'inactivo': 'warning',
            'graduado': 'info',
            'retirado': 'danger'
        };
        return colores[estado] || 'secondary';
    }

    // Formatear fecha
    function formatearFecha(fecha) {
        if (!fecha) return 'No registrado';
        return new Date(fecha).toLocaleDateString('es-ES');
    }

    // Generar paginación
    function generarPaginacion() {
        const totalPaginas = Math.ceil(estudiantesFiltrados.length / estudiantesPorPagina);
        const paginacion = document.getElementById('paginacion');
        
        if (totalPaginas <= 1) {
            paginacion.innerHTML = '';
            return;
        }

        let html = '';
        
        // Botón anterior
        html += `
            <li class="page-item ${paginaActual === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="cambiarPagina(${paginaActual - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;

        // Páginas
        for (let i = 1; i <= totalPaginas; i++) {
            if (i === 1 || i === totalPaginas || (i >= paginaActual - 2 && i <= paginaActual + 2)) {
                html += `
                    <li class="page-item ${i === paginaActual ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="cambiarPagina(${i})">${i}</a>
                    </li>
                `;
            } else if (i === paginaActual - 3 || i === paginaActual + 3) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }

        // Botón siguiente
        html += `
            <li class="page-item ${paginaActual === totalPaginas ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="cambiarPagina(${paginaActual + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;

        paginacion.innerHTML = html;
    }

    // Cambiar página
    function cambiarPagina(nuevaPagina) {
        const totalPaginas = Math.ceil(estudiantesFiltrados.length / estudiantesPorPagina);
        if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
            paginaActual = nuevaPagina;
            renderizarTabla();
        }
    }

    // Aplicar filtros MEJORADO - Sin bucles infinitos
    function aplicarFiltros() {
        // Evitar múltiples ejecuciones simultáneas
        if (isSearching) {
            console.log('Ya se está ejecutando una búsqueda, saltando...'); // Debug
            return;
        }
        
        isSearching = true;
        
        try {
            const busquedaElement = document.getElementById('busqueda');
            const gradoElement = document.getElementById('grado');
            const seccionElement = document.getElementById('seccion');
            const estadoElement = document.getElementById('estado');

            // Verificar que los elementos existen
            if (!busquedaElement || !gradoElement || !seccionElement || !estadoElement) {
                console.error('Algunos elementos de filtro no se encontraron');
                return;
            }

            const busqueda = busquedaElement.value.trim().toLowerCase();
            const grado = gradoElement.value;
            const seccion = seccionElement.value;
            const estado = estadoElement.value;

            console.log('Filtros aplicados:', { busqueda, grado, seccion, estado }); // Debug
            console.log('Total estudiantes:', estudiantesData.length); // Debug

            estudiantesFiltrados = estudiantesData.filter(estudiante => {
                // Filtro por búsqueda mejorado - busca en nombre, apellido Y documento
                let coincideBusqueda = true;
                if (busqueda) {
                    const nombreCompleto = `${estudiante.nombre || ''} ${estudiante.apellido || ''}`.toLowerCase().trim();
                    const documento = (estudiante.documento || '').toString().toLowerCase();
                    const email = (estudiante.email || '').toLowerCase();
                    
                    coincideBusqueda = 
                        nombreCompleto.includes(busqueda) ||
                        documento.includes(busqueda) ||
                        email.includes(busqueda);
                    
                    console.log(`Estudiante: ${nombreCompleto}, Documento: ${documento}, Coincide: ${coincideBusqueda}`); // Debug
                }

                // Filtros adicionales
                const coincideGrado = !grado || (estudiante.grado && estudiante.grado.toString() === grado);
                const coincideSeccion = !seccion || (estudiante.seccion === seccion);
                const coincideEstado = !estado || (estudiante.estado === estado);

                const resultado = coincideBusqueda && coincideGrado && coincideSeccion && coincideEstado;
                
                return resultado;
            });

            console.log('Estudiantes filtrados:', estudiantesFiltrados.length); // Debug

            // Reiniciar la paginación
            paginaActual = 1;
            
            // Actualizar la tabla y estadísticas
            renderizarTabla();
            actualizarEstadisticas();
            
        } catch (error) {
            console.error('Error en aplicarFiltros:', error);
        } finally {
            // Asegurar que el flag se resetee
            setTimeout(() => {
                isSearching = false;
            }, 100);
        }
    }

    // Limpiar filtros
    function limpiarFiltros() {
        console.log('Limpiando filtros...'); // Debug
        
        // Evitar bucles al limpiar
        clearTimeout(searchTimeout);
        isSearching = false;
        
        // Limpiar el formulario
        document.getElementById('filtrosForm').reset();
        
        // Restaurar datos originales
        estudiantesFiltrados = [...estudiantesData];
        paginaActual = 1;
        
        // Actualizar interfaz
        renderizarTabla();
        actualizarEstadisticas();
        cargarSecciones();
        
        // Limpiar indicadores
        document.getElementById('searchResults').classList.add('d-none');
        mostrarIndicadorBusqueda(false);
        
        console.log('Filtros limpiados, mostrando', estudiantesFiltrados.length, 'estudiantes'); // Debug
    }

    // Cargar secciones basadas en el grado
    function cargarSecciones() {
        const grado = document.getElementById('grado').value;
        const secciones = new Set();
        
        estudiantesData.forEach(estudiante => {
            if (!grado || estudiante.grado.toString() === grado) {
                if (estudiante.seccion) {
                    secciones.add(estudiante.seccion);
                }
            }
        });

        const select = document.getElementById('seccion');
        const valorActual = select.value;
        select.innerHTML = '<option value="">Todas las secciones</option>';
        
        Array.from(secciones).sort().forEach(seccion => {
            const option = document.createElement('option');
            option.value = seccion;
            option.textContent = seccion;
            if (seccion === valorActual) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    }

    // Actualizar estadísticas
    function actualizarEstadisticas() {
        const stats = {
            total: estudiantesFiltrados.length,
            activos: estudiantesFiltrados.filter(e => e.estado === 'activo').length,
            inactivos: estudiantesFiltrados.filter(e => e.estado === 'inactivo').length,
            graduados: estudiantesFiltrados.filter(e => e.estado === 'graduado').length
        };

        document.getElementById('totalEstudiantes').textContent = stats.total;
        document.getElementById('estudiantesActivos').textContent = stats.activos;
        document.getElementById('estudiantesInactivos').textContent = stats.inactivos;
        document.getElementById('estudiantesGraduados').textContent = stats.graduados;
    }

    // Selección de estudiantes
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.estudiante-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        actualizarSeleccion();
    }

    function actualizarSeleccion() {
        const checkboxes = document.querySelectorAll('.estudiante-checkbox:checked');
        estudiantesSeleccionados = Array.from(checkboxes).map(cb => cb.value);
        
        const selectAll = document.getElementById('selectAll');
        const totalCheckboxes = document.querySelectorAll('.estudiante-checkbox');
        
        selectAll.checked = checkboxes.length === totalCheckboxes.length;
        selectAll.indeterminate = checkboxes.length > 0 && checkboxes.length < totalCheckboxes.length;

        // Mostrar/ocultar botón de acciones masivas
        if (estudiantesSeleccionados.length > 0) {
            mostrarBotonAccionesMasivas();
        } else {
            ocultarBotonAccionesMasivas();
        }
    }

    // Ver estudiante
    function verEstudiante(id) {
        console.log('Ver estudiante:', id); // Debug
        window.location.href = `/admin/estudiantes/${id}`;
    }

    // Editar estudiante
    function editarEstudiante(id) {
        console.log('Editar estudiante:', id); // Debug
        window.location.href = `/admin/estudiantes/${id}/editar`;
    }

    // Eliminar estudiante
    function eliminarEstudiante(id) {
        console.log('Intentando eliminar estudiante con ID:', id); // Debug
        
        const estudiante = estudiantesData.find(e => e.id == id);
        if (!estudiante) {
            console.error('Estudiante no encontrado con ID:', id);
            showNotification('Error: Estudiante no encontrado', 'error');
            return;
        }

        console.log('Estudiante encontrado:', estudiante); // Debug

        // Usar un modal de Bootstrap en lugar de confirm() nativo
        mostrarModalConfirmacion(
            `¿Está seguro de eliminar al estudiante ${estudiante.nombre} ${estudiante.apellido}?`,
            'Esta acción no se puede deshacer.',
            () => {
                // Función que se ejecuta si confirma
                console.log('Confirmación de eliminación recibida'); // Debug
                ejecutarEliminacion(id);
            }
        );
    }

    // Función separada para ejecutar la eliminación
    function ejecutarEliminacion(id) {
        // Mostrar loading
        mostrarLoading(true);
        
        // Implementar eliminación
        fetch(`/admin/api/estudiantes/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('Respuesta del servidor:', response.status, response.statusText); // Debug
            
            if (response.ok) {
                // Si la eliminación fue exitosa
                showNotification('Estudiante eliminado correctamente', 'success');
                
                // Recargar los datos
                return cargarEstudiantes();
            } else {
                // Si hubo un error HTTP
                return response.text().then(text => {
                    console.error('Error del servidor:', text);
                    throw new Error(`Error ${response.status}: ${text || 'Error al eliminar estudiante'}`);
                });
            }
        })
        .then(() => {
            console.log('Estudiante eliminado y datos recargados'); // Debug
        })
        .catch(error => {
            console.error('Error en la eliminación:', error);
            showNotification(`Error al eliminar el estudiante: ${error.message}`, 'error');
        })
        .finally(() => {
            mostrarLoading(false);
        });
    }

    // Modal de confirmación personalizado
    function mostrarModalConfirmacion(titulo, mensaje, onConfirmar) {
        // Remover modal existente si existe
        const modalExistente = document.getElementById('modalConfirmacionEliminar');
        if (modalExistente) {
            modalExistente.remove();
        }

        // Crear modal
        const modal = document.createElement('div');
        modal.id = 'modalConfirmacionEliminar';
        modal.className = 'modal fade';
        modal.setAttribute('tabindex', '-1');
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            Confirmar Eliminación
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-2"><strong>${titulo}</strong></p>
                        <p class="text-muted mb-0">${mensaje}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">
                            <i class="fas fa-trash me-2"></i>
                            Eliminar
                        </button>
                    </div>
                </div>
            </div>
        `;

        // Agregar modal al DOM
        document.body.appendChild(modal);

        // Configurar evento del botón confirmar
        const btnConfirmar = modal.querySelector('#btnConfirmarEliminar');
        btnConfirmar.addEventListener('click', function() {
            // Cerrar modal
            const modalInstance = bootstrap.Modal.getInstance(modal);
            if (modalInstance) {
                modalInstance.hide();
            }
            
            // Ejecutar función de confirmación
            setTimeout(() => {
                onConfirmar();
                // Remover modal del DOM
                modal.remove();
            }, 300);
        });

        // Mostrar modal
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();

        // Limpiar modal cuando se cierre
        modal.addEventListener('hidden.bs.modal', function() {
            modal.remove();
        });
    }

    // Exportar estudiantes
    function exportarEstudiantes() {
        window.location.href = '/admin/estudiantes/exportar';
    }

    // Importar estudiantes
    function importarEstudiantes() {
        window.location.href = '/admin/estudiantes/importar';
    }

    // Función para mostrar notificaciones (necesaria para el código original)
    function showNotification(mensaje, tipo) {
        // Crear elemento de notificación
        const notification = document.createElement('div');
        notification.className = `alert alert-${tipo === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
        notification.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remover después de 5 segundos
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    // Funciones para acciones masivas (stubs - mantener compatibilidad)
    function mostrarBotonAccionesMasivas() {
        // Implementar según necesidad
        console.log('Mostrar botón acciones masivas');
    }

    function ocultarBotonAccionesMasivas() {
        // Implementar según necesidad
        console.log('Ocultar botón acciones masivas');
    }
</script>

<style>
    .avatar-inicial {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--gradient-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        box-shadow: 0 4px 12px rgba(142, 45, 226, 0.3);
    }

    .table th {
        background: rgba(142, 45, 226, 0.1);
        color: var(--primary-color);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.05em;
        border: none;
        padding: 1rem;
    }

    .table td {
        padding: 1rem;
        vertical-align: middle;
        border-color: rgba(226, 232, 240, 0.3);
    }

    .table-hover tbody tr:hover {
        background: rgba(142, 45, 226, 0.05);
    }

    .btn-group .btn {
        margin: 0 2px;
    }

    .page-link {
        border-radius: 8px;
        margin: 0 2px;
        border: 2px solid rgba(142, 45, 226, 0.2);
        color: var(--primary-color);
        font-weight: 600;
    }

    .page-item.active .page-link {
        background: var(--gradient-primary);
        border-color: var(--primary-color);
        color: white;
    }

    .page-link:hover {
        background: rgba(142, 45, 226, 0.1);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .card.border-primary { border-left: 4px solid var(--primary-color) !important; }
    .card.border-success { border-left: 4px solid var(--success-color) !important; }
    .card.border-warning { border-left: 4px solid var(--warning-color) !important; }
    .card.border-info { border-left: 4px solid var(--info-color) !important; }

    .spinner-border {
        animation: spinner-border 0.75s linear infinite;
    }

    /* Estilos para el indicador de búsqueda mejorado */
    .search-indicator {
        position: absolute;
        right: 50px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--primary-color);
        z-index: 10;
    }

    .input-group.position-relative {
        position: relative;
    }

    /* Mejoras visuales para resultados de búsqueda */
    #searchResults {
        font-size: 0.875rem;
        margin-top: 0.25rem;
        font-weight: 500;
    }

    /* Animación suave para cambios */
    .table-responsive {
        transition: opacity 0.2s ease-in-out;
    }

    /* Estilo mejorado para el loading */
    #loadingIndicator {
        transition: all 0.3s ease-in-out;
    }
</style>
{% endblock %}